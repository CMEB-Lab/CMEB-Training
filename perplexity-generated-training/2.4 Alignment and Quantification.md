<img src=“https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png” class=“logo” width=“120”/>

# Alignment & Quantification Training Manual (Module 2.4)

A 24-hour, competency-based program to master read alignment, splice-aware mapping, and transcript quantification workflows essential for RNA-seq analysis and technical interviews.

## Learning Objectives

By module completion, learners will be able to:

1. **Configure and run** splice-aware aligners (STAR, HISAT2) with optimal parameters.
2. **Interpret alignment statistics** and diagnose common artefacts.
3. **Perform pseudo-alignment** with Salmon and kallisto, comparing speed and accuracy.
4. **Integrate alignment and quantification** into reproducible pipelines with robust logging.

## Week 1 (Days 1–3): Splice-Aware Alignment

### Day 1: HISAT2 Fundamentals (8 hours)

**Concepts & Setup**

- Graph-based FM-index: hierarchical indexing of genome + splicing (“exon–junction”).
- Building indices vs. using prebuilt: trade-offs in speed and memory.

**Hands-On Exercises**

1. Index preparation
```bash
hisat2-build GRCh38.fa GRCh38_index
```

2. Single-end alignment
```bash
hisat2 -p 8 \
  —dta \  
  -x GRCh38_index \
  -U sample_R1.fastq \
  -S sample.sam 2> sample.log
```

3. Paired-end alignment
```bash
hisat2 -p 8 —dta \
  -x GRCh38_index \
  -1 sample_R1.fastq -2 sample_R2.fastq \
  -S paired.sam 2> paired.log
```

**Log Interpretation**

- `reported N alignments; M paired-end reads; X% aligned once; Y% aligned > once; Z% aligned 0 times`.
- Diagnose low alignment: check adapter contamination, read quality, index mismatch.

**Deliverables**

- A summary table of alignment rates per sample.
- Script `run_hisat2.sh` that loops over FASTQ files, aligns, and aggregates rates.


### Day 2: STAR Alignment Workflow (8 hours)

**Conceptual Overview**

- Two-pass mode for novel splice junction discovery.
- Genome and splice junction indices for dynamic mapping.

**Hands-On Exercises**

1. Generate genome index
```bash
STAR —runThreadN 12 \
  —runMode genomeGenerate \
  —genomeDir star_index/ \
  —genomeFastaFiles GRCh38.fa \
  —sjdbGTFfile genes.gtf \
  —sjdbOverhang 100
```

2. Two-pass alignment
```bash
# Pass 1
STAR —runThreadN 12 \
  —genomeDir star_index/ \
  —readFilesIn sample_R1.fastq sample_R2.fastq \
  —outFileNamePrefix pass1/sample_ \
  —outSJfilterOverhangMin 8 8 8 8

# Collect splice junctions
cat pass1/*SJ.out.tab > all_sj.tab

# Build augmented index
STAR —runThreadN 12 \
  —runMode genomeGenerate \
  —genomeDir star_index_2pass/ \
  —genomeFastaFiles GRCh38.fa \
  —sjdbFileChrStartEnd all_sj.tab \
  —sjdbOverhang 100

# Pass 2
STAR —runThreadN 12 \
  —genomeDir star_index_2pass/ \
  —readFilesIn sample_R1.fastq sample_R2.fastq \
  —outFileNamePrefix pass2/sample_
```

3. Convert to BAM, sort, index
```bash
samtools view -bS pass2/sample_Aligned.out.sam | \
  samtools sort -o sample_sorted.bam
samtools index sample_sorted.bam
```

**Log Interpretation**

- `% uniquely mapped`, `% multi-mapped`, splice junction detection counts.
- Identify GC bias or read-length artifacts.

**Deliverables**

- `run_star_2pass.sh` automating two-pass alignment across samples.
- Comparison report: HISAT2 vs. STAR alignment statistics.


### Day 3: Alignment Diagnostics & Optimization (8 hours)

**Exercises**

1. Alignment QC with `samtools flagstat` and `Qualimap`
```bash
samtools flagstat sample_sorted.bam > flagstat.txt
qualimap bamqc -bam sample_sorted.bam -outdir qualimap_report/
```

2. Splice junction analysis:
```bash
grep -v “^@“ sample.sam | awk ‘$3!=“*”{print $0}’ | wc -l
```

3. Filter low-quality alignments (MAPQ < 20):
```bash
samtools view -b -q 20 sample_sorted.bam > sample_MAPQ20.bam
```

**Deliverables**

- QC dashboard summarizing mapping quality, insert size distribution, strand specificity.
- Recommendations for parameter tuning (e.g., `—mp`, `—sp`, `—score-min`).


## Week 2 (Days 4–6): Pseudo-Alignment & Quantification

### Day 4: Salmon Quantiﬁcation (8 hours)

**Concepts**

- Lightweight alignment via quasi-mapping.
- Decoy sequences and selective alignment to reduce bias.

**Hands-On Exercises**

1. Index transcriptome
```bash
salmon index -t transcripts.fa \
  —decoys decoys.txt \
  -i salmon_index —type quasi -k 31
```

2. Quantify reads
```bash
salmon quant -i salmon_index \
  -l A \
  -1 sample_R1.fastq \
  -2 sample_R2.fastq \
  -p 8 \
  —validateMappings \
  -o salmon_out/sample
```

3. Interpret `quant.sf`:

- `TPM`, `NumReads`, `NumEQClasses`.

**Deliverables**

- Script `run_salmon.sh` for batch quantification.
- Table comparing Salmon TPMs vs. STAR+featureCounts counts.


### Day 5: kallisto Quantiﬁcation (8 hours)

**Concepts**

- Pseudo-alignment via k-mer hashing.
- Bootstrapping for inferential variance.

**Hands-On Exercises**

1. Build index
```bash
kallisto index -i kallisto.idx transcripts.fa
```

2. Quantify reads
```bash
kallisto quant -i kallisto.idx \
  -o kallisto_out/sample \
  -b 100 \
  sample_R1.fastq sample_R2.fastq
```

3. Analyze bootstraps for uncertainty.

**Deliverables**

- `run_kallisto.sh` automating kallisto quantification.
- Comparison report: runtime, memory usage, correlation of TPMs (kallisto vs. Salmon).


### Day 6: Integration & Pipeline Automation (8 hours)

**Pipeline Assembly**

- Combine alignment (STAR) and quantification (Salmon/kallisto) into a Snakemake workflow.
- Use conda environments per rule; generate HTML report with MultiQC.

**Example Snakemake Snakefile**

```python
rule all:
    input:
        expand(“salmon_out/{sample}/quant.sf”, sample=SAMPLES),
        expand(“kallisto_out/{sample}/abundance.tsv”, sample=SAMPLES)

rule star_index:
    input: FASTA=“GRCh38.fa”, GTF=“genes.gtf”
    output: directory(“star_index_2pass”)
    shell: “bash run_star_index.sh”

rule star_align:
    input: R1=“{sample}_R1.fastq”, R2=“{sample}_R2.fastq”, idx=“star_index_2pass”
    output: “aligned/{sample}.bam”
    shell: “bash run_star_2pass.sh {input.R1} {input.R2} {output}”

rule salmon_quant:
    input: idx=“salmon_index”, R1=“{sample}_R1.fastq”, R2=“{sample}_R2.fastq”
    output: directory(“salmon_out/{sample}”)
    shell: “bash run_salmon.sh {input.R1} {input.R2} {output}”

rule kallisto_quant:
    input: idx=“kallisto.idx”, R1=“{sample}_R1.fastq”, R2=“{sample}_R2.fastq”
    output: directory(“kallisto_out/{sample}”)
    shell: “bash run_kallisto.sh {input.R1} {input.R2} {output}”
```

**Deliverables**

- Complete Snakemake pipeline repository with config file.
- Continuous integration via GitHub Actions to lint code, test on small dataset, and generate a QC report.


## Assessment Framework

| Competency Area | Beginner (0–60%) | Intermediate (61–80%) | Advanced (81–100%) |
| :— | :— | :— | :— |
| **Splice-Aware Alignment** | Runs HISAT2/STAR with defaults | Tunes parameters, interprets logs | Implements two-pass, builds custom indices, optimizes memory |
| **Quantification** | Executes Salmon/kallisto scripts | Compares TPM vs. counts, interprets bootstraps | Integrates selective alignment, accounts for decoys, bias correction |
| **Pipeline Automation** | Writes ad-hoc shell scripts | Develops Snakemake workflows | Implements CI/CD, containerization, automated report generation |

**Key References**

1. HISAT2 manual & publications
2. STAR aligner documentation
3. Salmon: Patro et al. Nat Methods 2017
4. kallisto: Bray et al. Nat Biotechnol 2016
5. Snakemake workflow best practices

Upon completion, learners will possess the practical expertise to execute, optimize, and automate alignment and quantification workflows at production scale—critical for research excellence and technical interviews.

